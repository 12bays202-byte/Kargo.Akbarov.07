<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöö –°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –†–µ–π—Å–∞–º–∏</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        
        .login-page { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; border-radius: 20px; padding: 40px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .login-title { text-align: center; font-size: 2em; color: #2c3e50; margin-bottom: 30px; }
        .login-icon { text-align: center; font-size: 4em; margin-bottom: 20px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .input-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; }
        .input-group input:focus { outline: none; border-color: #667eea; }
        .btn-login { width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; }
        .btn-login:hover { background: #5568d3; }
        .error-msg { color: #e74c3c; text-align: center; margin-top: 15px; font-weight: 600; }
        .success-msg { color: #27ae60; text-align: center; margin-top: 15px; font-weight: 600; }
        
        .container { max-width: 2400px; margin: 0 auto; padding: 20px; }
        .header { background: white; border-radius: 20px; padding: 20px 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header-left h1 { color: #2c3e50; font-size: 1.8em; margin-bottom: 5px; }
        .header-left p { color: #7f8c8d; }
        .header-right { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .user-email { font-weight: 600; color: #2c3e50; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.95em; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-logout { background: #e74c3c; color: white; }
        .btn-download { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-delete { background: #c0392b; color: white; padding: 8px 15px; font-size: 0.9em; }
        .btn-print-invoice { background: #3498db; color: white; padding: 8px 15px; font-size: 0.95em; }
        
        .tabs { background: white; border-radius: 15px; padding: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; gap: 10px; flex-wrap: wrap; }
        .tab { padding: 12px 30px; border: none; border-radius: 10px; font-weight: 700; font-size: 1em; cursor: pointer; background: #f0f0f0; color: #666; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; }
        .tab:hover:not(.active) { background: #e0e0e0; }
        
        .upload-section { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 40px; cursor: pointer; transition: all 0.3s ease; background: #f8f9fa; }
        .upload-area:hover { background: #e9ecef; border-color: #764ba2; }
        .upload-icon { font-size: 4em; margin-bottom: 15px; }
        
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .order-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative; transition: all 0.3s ease; }
        .order-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.25); }
        .order-card-content { cursor: pointer; }
        .order-icon { font-size: 3em; text-align: center; margin-bottom: 10px; }
        .order-title { font-size: 1.1em; font-weight: 700; color: #2c3e50; margin-bottom: 8px; text-align: center; }
        .order-info { color: #7f8c8d; font-size: 0.9em; text-align: center; margin-bottom: 5px; }
        .order-actions { display: flex; justify-content: center; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #f0f0f0; }
        
        .database-section { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow-x: auto; margin-bottom: 20px; }
        .database-table { width: 100%; border-collapse: collapse; min-width: 1800px; }
        .database-table th { background: #4a4a4a; color: white; padding: 16px; text-align: center; font-weight: 700; border: 1px solid #000; font-size: 15px; height: 50px; }
        .database-table td { padding: 14px; border: 1px solid #000; font-weight: 600; font-size: 15px; position: relative; height: 55px; }
        .database-table tbody tr:hover { background: #f0f0f0; }
        .editable-cell { cursor: pointer; transition: all 0.2s; }
        .editable-cell:hover { background: #fff3cd !important; }
        .cell-input { width: 100%; border: 2px solid #667eea; padding: 10px; font-size: 15px; font-weight: 600; box-sizing: border-box; }
        .cell-input:focus { outline: none; border-color: #764ba2; }
        
        .som-column { background: #fff8dc !important; font-weight: bold; }
        
        .status-cell { text-align: center; cursor: pointer; font-weight: bold; }
        .status-unpaid { background: #f8d7da; color: #721c24; }
        .status-paid { background: #d4edda; color: #155724; }
        
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .filter-btn.active { background: #667eea; color: white; }
        .filter-btn:not(.active) { background: #f0f0f0; color: #666; }
        .filter-btn:hover:not(.active) { background: #e0e0e0; }
        
        .table-filters { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        .search-input { padding: 10px 15px; border: 2px solid #667eea; border-radius: 10px; font-size: 0.95em; min-width: 250px; }
        .search-input:focus { outline: none; border-color: #764ba2; }
        
        .date-filter { padding: 10px 15px; border: 2px solid #667eea; border-radius: 10px; font-size: 0.95em; font-weight: 600; }
        
        .totals-summary { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .totals-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .total-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .total-card-label { color: #7f8c8d; font-size: 0.9em; margin-bottom: 8px; }
        .total-card-value { font-size: 2em; font-weight: bold; }
        .total-all { color: #2c3e50; }
        .total-paid { color: #27ae60; }
        .total-unpaid { color: #e74c3c; }
        .total-som { color: #f39c12; }
        .employee-debts { margin-top: 15px; }
        .employee-debt-item { background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .employee-name { font-weight: bold; color: #2c3e50; }
        .employee-debt { font-size: 1.2em; font-weight: bold; color: #e74c3c; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; padding: 30px; max-width: 98%; width: 100%; max-height: 95vh; overflow: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
        .modal-close { position: fixed; top: 30px; right: 30px; font-size: 3em; cursor: pointer; color: white; background: #e74c3c; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1001; }
        .modal-close:hover { transform: rotate(90deg) scale(1.1); }
        .modal-title { font-size: 1.8em; font-weight: 700; color: #2c3e50; margin-bottom: 20px; text-align: center; }
        
        .hidden { display: none !important; }

        .invoice-print-area { display: none; }
        
        .total-row {
            background: #fffacd !important;
            font-weight: bold;
            font-size: 16px;
        }
        
        .total-row td {
            background: #fffacd !important;
            border: 2px solid #000 !important;
            padding: 16px !important;
            height: 60px !important;
        }
        
        @media print {
            body * { visibility: hidden; }
            
            .invoice-print-area, .invoice-print-area * { 
                visibility: visible; 
            }
            
            .invoice-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
            }
            
            .invoice-print-area:empty {
                display: none !important;
            }
            
            .print-invoice {
                page-break-inside: avoid;
                margin-bottom: 5mm;
                height: 50vh;
            }
            
            .print-invoice-header {
                text-align: center;
                font-size: 20px;
                font-weight: bold;
                padding: 15px;
                border: 3px solid #000;
                margin-bottom: 10px;
            }
            
            .print-invoice-table {
                width: 100%;
                border-collapse: collapse;
                border: 3px solid #000;
                margin-bottom: 10px;
            }
            
            .print-invoice-table th,
            .print-invoice-table td {
                border: 2px solid #000;
                padding: 12px;
                text-align: center;
                font-size: 15px;
            }
            
            .print-invoice-table th {
                background: #f0f0f0;
                font-weight: bold;
                height: 40px;
            }
            
            .print-invoice-table tbody tr {
                height: 45px;
            }
            
            .print-invoice-footer {
                display: flex;
                justify-content: space-between;
                margin-top: 15px;
                padding: 15px;
                border: 3px solid #000;
                font-size: 14px;
            }
        }
        
        @media print {
            body:not(:has(.invoice-print-area:not(:empty))) * {
                visibility: visible !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .header,
            body:not(:has(.invoice-print-area:not(:empty))) .tabs,
            body:not(:has(.invoice-print-area:not(:empty))) .filters,
            body:not(:has(.invoice-print-area:not(:empty))) .table-filters,
            body:not(:has(.invoice-print-area:not(:empty))) .totals-summary,
            body:not(:has(.invoice-print-area:not(:empty))) .btn,
            body:not(:has(.invoice-print-area:not(:empty))) button {
                display: none !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .database-section {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .modal-content {
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .database-table {
                table-layout: fixed !important;
                width: 100% !important;
                font-size: 13px !important;
                border-collapse: collapse !important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .database-table th,
            body:not(:has(.invoice-print-area:not(:empty))) .database-table td {
                width: calc(95% / 25) !important;
                padding: 0px !important;
                font-size: 13px !important;
                line-height: 1 !important;
                overflow: hidden !important;
                text-overflow: clip !important;
                white-space: nowrap !important;
                border: 2px solid #000000 !important;
                text-align: center!important;
                vertical-align: middle!important;
            }
            
            body:not(:has(.invoice-print-area:not(:empty))) .employee-select,
            body:not(:has(.invoice-print-area:not(:empty))) .cell-input {
                border: none !important;
                padding: 0 !important;
                font-size: 13px !important;
            }
        }
        
        body:not(:has(.invoice-print-area:not(:empty))) .database-section {
            transform: scale(0.90);
            transform-origin: top left;
            width: 117%;
        }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .tabs { flex-direction: column; }
            .orders-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-page">
        <div class="login-box">
            <div class="login-icon">üîê</div>
            <div class="login-title" id="authTitle">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</div>
            
            <div id="loginForm">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="example@gmail.com">
                </div>
                <div class="input-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="loginPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn-login" onclick="login()">–í–æ–π—Ç–∏</button>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="showRegisterForm(); return false;" style="color: #667eea; text-decoration: none; font-weight: 600;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
                </div>
            </div>
            
            <div id="registerForm" class="hidden">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="example@gmail.com">
                </div>
                <div class="input-group">
                    <label>–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="registerPassword" placeholder="–°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="input-group">
                    <label>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <button class="btn-login" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="showLoginForm(); return false;" style="color: #667eea; text-decoration: none; font-weight: 600;">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
                </div>
            </div>
            
            <div id="loginError" class="error-msg"></div>
        </div>
    </div>

    <div id="mainPage" class="hidden">
        <div class="container">
            <div class="header">
                <div class="header-left">
                    <h1>üöö –°–∏—Å—Ç–µ–º–∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –†–µ–π—Å–∞–º–∏</h1>
                    <p>–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ Excel —Ñ–∞–π–ª—ã - –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª = –æ–¥–∏–Ω —Ä–µ–π—Å</p>
                </div>
                <div class="header-right">
                    <div class="user-email" id="userEmail"></div>
                    <button class="btn btn-logout" onclick="logout()">–í—ã—Ö–æ–¥</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('main')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
                <button class="tab" onclick="switchTab('database')">üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</button>
                <button class="tab hidden" id="adminTabBtn" onclick="switchTab('admin')">‚öôÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</button>
            </div>

            <div id="mainTab">
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <div class="upload-icon">üìÅ</div>
                        <div style="font-size: 1.3em; font-weight: 600; color: #2c3e50;">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã</div>
                        <div style="color: #7f8c8d; margin-top: 10px;">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ —Å—Ä–∞–∑—É</div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls" multiple style="display: none;">
                    </div>
                </div>

                <div class="totals-summary" id="mainTotalsSummary"></div>

                <div class="filters">
                    <button class="filter-btn active" onclick="setMainFilter('all')">üìã –í—Å–µ —Ä–µ–π—Å—ã</button>
                    <button class="filter-btn" onclick="setMainFilter('paid')">‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
                    <button class="filter-btn" onclick="setMainFilter('unpaid')">‚ùå –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
                    <button class="btn btn-download" onclick="downloadAllOrders()" style="margin-left: auto;">üíæ –°–∫–∞—á–∞—Ç—å –≤—Å–µ</button>
                    <button class="btn btn-download" onclick="printMain()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                </div>

                <div class="orders-grid" id="ordersGrid"></div>
            </div>

            <div id="databaseTab" class="hidden">
                <div class="totals-summary" id="totalsSummary"></div>
                
                <div class="filters">
                    <button class="filter-btn active" onclick="setFilter('all')">üìã –í—Å–µ</button>
                    <button class="filter-btn" onclick="setFilter('paid')">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>
                    <button class="filter-btn" onclick="setFilter('unpaid')">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</button>
                    <select id="employeeFilter" onchange="filterByEmployee()" style="padding: 10px; border-radius: 10px; font-weight: 600; border: 2px solid #667eea; margin-left: 10px;">
                        <option value="">üë§ –í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                    </select>
                    <input type="date" id="dateFilterFrom" class="date-filter" onchange="filterByDate()" placeholder="–° –¥–∞—Ç—ã">
                    <input type="date" id="dateFilterTo" class="date-filter" onchange="filterByDate()" placeholder="–î–æ –¥–∞—Ç—ã">
                    <button class="btn btn-success" onclick="clearDateFilter()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å –¥–∞—Ç—ã</button>
                    <button class="btn btn-download" onclick="downloadDatabase()" style="margin-left: auto;">üíæ –°–∫–∞—á–∞—Ç—å</button>
                    <button class="btn btn-download" onclick="printDatabase()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
                </div>
                
                <div class="database-section">
                    <h2 style="margin-bottom: 20px; text-align: center; color: #2c3e50;">üìä –í—Å–µ —Ä–µ–π—Å—ã –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ</h2>
                    <div class="table-filters">
                        <input type="text" id="dbSearchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ..." oninput="filterDatabaseTable()">
                        <button class="btn btn-success" onclick="clearDatabaseSearch()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="database-table" id="databaseTable">
                            <thead id="databaseTableHead"></thead>
                            <tbody id="databaseTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="adminTab" class="hidden">
                <div class="database-section" style="margin-bottom: 20px;">
                    <h2 style="margin-bottom: 20px; text-align: center; color: #2c3e50;">üí± –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—É—Ä—Å–∞</h2>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; display: flex; gap: 15px; align-items: center; justify-content: center; flex-wrap: wrap;">
                        <label style="font-weight: 600; font-size: 1.1em;">–ö—É—Ä—Å USD ‚Üí KGZ:</label>
                        <input type="number" id="kgzRateInput" step="0.1" 
                               style="padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 1.1em; font-weight: 600; width: 150px;"
                               onchange="updateKgzRate(this.value)">
                        <span style="color: #7f8c8d;">—Å–æ–º</span>
                    </div>
                </div>
                
                <div class="database-section">
                    <h2 style="margin-bottom: 20px; text-align: center; color: #2c3e50;">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="email" id="newUserEmail" placeholder="Email" style="flex: 1; min-width: 200px; padding: 10px; border: 2px solid #667eea; border-radius: 8px;">
                            <input type="password" id="newUserPassword" placeholder="–ü–∞—Ä–æ–ª—å" style="flex: 1; min-width: 200px; padding: 10px; border: 2px solid #667eea; border-radius: 8px;">
                            <button class="btn btn-success" onclick="addNewUser()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
                        </div>
                        <div id="addUserMessage" style="margin-top: 10px; font-weight: 600;"></div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="database-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>–ü–∞—Ä–æ–ª—å</th>
                                    <th>–¢–∏–ø</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="database-section">
                    <h2 style="margin-bottom: 20px; text-align: center; color: #2c3e50;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</h2>
                    <div id="userStatsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <span class="modal-close" id="modalClose">√ó</span>
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            
            <div id="modalTotalsSummary" class="totals-summary"></div>
            
            <div style="text-align: center; margin-bottom: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-download" onclick="downloadCurrentOrder('unpaid')">üíæ –°–∫–∞—á–∞—Ç—å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ</button>
                <button class="btn btn-download" onclick="downloadCurrentOrder('all')">üíæ –°–∫–∞—á–∞—Ç—å –≤—Å–µ</button>
                <button class="filter-btn active" onclick="setModalFilter('all')">üìã –í—Å–µ</button>
                <button class="filter-btn" onclick="setModalFilter('paid')">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ</button>
                <button class="filter-btn" onclick="setModalFilter('unpaid')">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</button>
                <button class="btn btn-download" onclick="printModal()">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
            </div>
            <div class="table-filters">
                <input type="text" id="modalSearchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ..." oninput="filterModalTable()">
                <button class="btn btn-success" onclick="clearModalSearch()">‚úñ –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div id="tableWrapper"></div>
        </div>
    </div>

    <div class="invoice-print-area" id="invoicePrintArea"></div>

    <script>
let currentUser = null;
let orders = [];
let currentOrder = null;
let currentTab = 'main';
let currentFilter = 'all';
let mainFilter = 'all';
let modalFilter = 'all';
let employeeFilter = '';
let dateFilterFrom = '';
let dateFilterTo = '';

const ADMIN_EMAIL = '12abc202@gmail.com';
const ADMIN_PASSWORD = 'Abu_1610';
const EMPLOYEES = ['–ú—É—Ö–∞–º–º–∞–¥ –ê–º–∏–Ω', '–ê–Ω–≤–∞—Ä', '–ñ–æ–ª–¥–∏–≤–æ–π', '–°–∏—Ä–æ–∂', '–ù–∏–∞–∑', '–ê–≤–∞–∑–±–µ–∫', '–ê–±–¥—É–º–∞–ª–∏–∫', '–ú—É–∑–∞—Ñ—Ñ–∞—Ä', '–§–∞—Ä—É—Ö', '–ì–∞–π—Ä–∞—Ç', '–ù—É—Ä–∏–¥–∏–Ω', '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä'];

function getKgzRate() {
    const rate = localStorage.getItem('kgz_rate');
    if (!rate) {
        localStorage.setItem('kgz_rate', '88.5');
        return 88.5;
    }
    return parseFloat(rate);
}

function setKgzRate(rate) {
    localStorage.setItem('kgz_rate', rate.toString());
}

function calculateSom(sumDollar, yulKira) {
    const total = (parseFloat(sumDollar) || 0) + (parseFloat(yulKira) || 0);
    return Math.round(total * getKgzRate());
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ —Ä–µ–π—Å–∞ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
function extractFlightNumber(fileName) {
    const match = fileName.match(/(\d+)/);
    return match ? parseInt(match[1]) : 999999;
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ä–µ–π—Å–æ–≤ –ø–æ –Ω–æ–º–µ—Ä—É
function sortOrdersByFlightNumber() {
    orders.sort((a, b) => {
        const numA = extractFlightNumber(a.fileName);
        const numB = extractFlightNumber(b.fileName);
        return numA - numB;
    });
}

function init() {
    initializeUsers();
    checkAuth();
    populateEmployeeFilter();
}

function populateEmployeeFilter() {
    const select = document.getElementById('employeeFilter');
    EMPLOYEES.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp;
        option.textContent = emp;
        select.appendChild(option);
    });
}

function initializeUsers() {
    if (!localStorage.getItem('users')) {
        const users = [
            { email: ADMIN_EMAIL, password: ADMIN_PASSWORD, isAdmin: true }
        ];
        localStorage.setItem('users', JSON.stringify(users));
    }
}

function checkAuth() {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainPage();
    } else {
        showLoginPage();
    }
}

function showLoginPage() {
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('mainPage').classList.add('hidden');
    showLoginForm();
}

function showLoginForm() {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
    document.getElementById('authTitle').textContent = '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É';
    document.getElementById('loginError').textContent = '';
}

function showRegisterForm() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerForm').classList.remove('hidden');
    document.getElementById('authTitle').textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
    document.getElementById('loginError').textContent = '';
}

function showMainPage() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('mainPage').classList.remove('hidden');
    document.getElementById('userEmail').textContent = currentUser.email;
    
    const adminTabBtn = document.getElementById('adminTabBtn');
    if (currentUser.isAdmin) {
        adminTabBtn.classList.remove('hidden');
        document.getElementById('kgzRateInput').value = getKgzRate();
    } else {
        adminTabBtn.classList.add('hidden');
    }
    
    loadUserOrders();
}

function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorMsg = document.getElementById('loginError');

    if (!email || !password) {
        errorMsg.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        errorMsg.className = 'error-msg';
        return;
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => u.email === email && u.password === password);

    if (user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        showMainPage();
    } else {
        errorMsg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ';
        errorMsg.className = 'error-msg';
    }
}

function register() {
    const email = document.getElementById('registerEmail').value.trim();
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    const errorMsg = document.getElementById('loginError');

    if (!email || !password || !passwordConfirm) {
        errorMsg.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        errorMsg.className = 'error-msg';
        return;
    }

    if (password !== passwordConfirm) {
        errorMsg.textContent = '–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç';
        errorMsg.className = 'error-msg';
        return;
    }

    if (password.length < 4) {
        errorMsg.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞';
        errorMsg.className = 'error-msg';
        return;
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    
    if (users.find(u => u.email === email)) {
        errorMsg.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
        errorMsg.className = 'error-msg';
        return;
    }

    users.push({ email, password, isAdmin: false });
    localStorage.setItem('users', JSON.stringify(users));

    errorMsg.textContent = '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É';
    errorMsg.className = 'success-msg';
    
    document.getElementById('registerEmail').value = '';
    document.getElementById('registerPassword').value = '';
    document.getElementById('registerPasswordConfirm').value = '';

    setTimeout(() => {
        showLoginForm();
    }, 2000);
}

function logout() {
    localStorage.removeItem('currentUser');
    currentUser = null;
    orders = [];
    showLoginPage();
}

function loadUserOrders() {
    let savedOrders;
    if (currentUser.isAdmin) {
        savedOrders = localStorage.getItem('all_orders');
    } else {
        savedOrders = localStorage.getItem(`orders_${currentUser.email}`);
    }
    
    if (savedOrders) {
        orders = JSON.parse(savedOrders);
        sortOrdersByFlightNumber(); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    } else {
        orders = [];
    }
    renderAll();
}

function saveUserOrders() {
    sortOrdersByFlightNumber(); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    
    if (currentUser.isAdmin) {
        localStorage.setItem('all_orders', JSON.stringify(orders));
    } else {
        localStorage.setItem(`orders_${currentUser.email}`, JSON.stringify(orders));
        let allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
        allOrders = allOrders.filter(o => o.userEmail !== currentUser.email);
        orders.forEach(o => {
            o.userEmail = currentUser.email;
            allOrders.push(o);
        });
        localStorage.setItem('all_orders', JSON.stringify(allOrders));
    }
}

function switchTab(tab) {
    currentTab = tab;
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');

    document.getElementById('mainTab').classList.add('hidden');
    document.getElementById('databaseTab').classList.add('hidden');
    document.getElementById('adminTab').classList.add('hidden');

    if (tab === 'main') {
        document.getElementById('mainTab').classList.remove('hidden');
    } else if (tab === 'database') {
        document.getElementById('databaseTab').classList.remove('hidden');
    } else if (tab === 'admin') {
        document.getElementById('adminTab').classList.remove('hidden');
        renderAdminPanel();
    }
    
    renderAll();
}

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const modal = document.getElementById('modal');
const modalClose = document.getElementById('modalClose');

uploadArea.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFiles);

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.style.background = '#667eea';
    uploadArea.style.color = 'white';
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.style.background = '#f8f9fa';
    uploadArea.style.color = '';
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.style.background = '#f8f9fa';
    uploadArea.style.color = '';
    handleFiles({ target: { files: e.dataTransfer.files } });
});

modalClose.addEventListener('click', () => modal.classList.remove('active'));
modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.classList.remove('active');
});

function handleFiles(e) {
    const files = Array.from(e.target.files);
    
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '', raw: false });

                const rowsWithStatus = jsonData.map((row, index) => {
                    if (index === 0) {
                        return row;
                    } else {
                        return {
                            data: row,
                            status: '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ',
                            paymentDate: null,
                            employee: '',
                            rowId: index
                        };
                    }
                });

                const order = {
                    id: Date.now() + Math.random(),
                    fileName: file.name,
                    data: rowsWithStatus,
                    uploadDate: new Date().toLocaleDateString('ru-RU'),
                    userEmail: currentUser.email
                };

                orders.push(order);
                saveUserOrders();
                renderAll();
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + file.name);
            }
        };
        reader.readAsArrayBuffer(file);
    });
}

function deleteOrder(orderId, event) {
    if (event) {
        event.stopPropagation();
    }
    
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–µ–π—Å?')) {
        orders = orders.filter(o => o.id !== orderId);
        saveUserOrders();
        renderAll();
    }
}

function findPriceColumn(headers) {
    for (let i = 0; i < headers.length; i++) {
        const headerStr = String(headers[i]).toLowerCase();
        if (headerStr.includes('—Ü–µ–Ω–∞') || headerStr.includes('price') || headerStr.includes('0.')) {
            return i;
        }
    }
    return -1;
}

function isHeaderRow(row, headers) {
    if (!row.data || row.data.length === 0) return false;
    
    for (let i = 0; i < Math.min(3, row.data.length); i++) {
        const cellValue = String(row.data[i] || '').toLowerCase().trim();
        const headerValue = String(headers[i] || '').toLowerCase().trim();
        
        if (cellValue === headerValue || 
            cellValue === '‚Ññ' || 
            cellValue === '—Ñ–∏–æ' || 
            cellValue === '–∂–∞–º–∏') {
            return true;
        }
    }
    return false;
}

function isDateInRange(paymentDate) {
    if (!dateFilterFrom && !dateFilterTo) return true;
    if (!paymentDate) return false;

    const dateParts = paymentDate.split(' ')[0].split('.');
    const dateObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);

    if (dateFilterFrom && dateFilterTo) {
        const fromDate = new Date(dateFilterFrom);
        const toDate = new Date(dateFilterTo);
        return dateObj >= fromDate && dateObj <= toDate;
    } else if (dateFilterFrom) {
        const fromDate = new Date(dateFilterFrom);
        return dateObj >= fromDate;
    } else if (dateFilterTo) {
        const toDate = new Date(dateFilterTo);
        return dateObj <= toDate;
    }
    return true;
}

function calculateTotals() {
    let totalAll = 0;
    let totalPaid = 0;
    let totalUnpaid = 0;
    let totalSom = 0;
    let totalSomPaid = 0;
    let totalSomUnpaid = 0;
    let employeeDebts = {};
    
    orders.forEach(order => {
        const headers = order.data[0];
        order.data.forEach((row, idx) => {
            if (idx > 0 && row.data && row.data.some(cell => cell && String(cell).trim() !== '')) {
                if (isHeaderRow(row, headers)) return;
                
                if (currentFilter === 'all' || 
                    (currentFilter === 'paid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') || 
                    (currentFilter === 'unpaid' && row.status === '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ')) {
                    if (!employeeFilter || row.employee === employeeFilter) {
                        if (isDateInRange(row.paymentDate)) {
                            const sumDollar = parseFloat(row.data[11]) || 0;
                            const yulKira = parseFloat(row.data[12]) || 0;
                            const totalSum = sumDollar + yulKira;
                            const som = calculateSom(sumDollar, yulKira);
                            
                            totalAll += totalSum;
                            totalSom += som;
                            
                            if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                                totalPaid += totalSum;
                                totalSomPaid += som;
                            } else {
                                totalUnpaid += totalSum;
                                totalSomUnpaid += som;
                                
                                if (row.employee) {
                                    if (!employeeDebts[row.employee]) {
                                        employeeDebts[row.employee] = 0;
                                    }
                                    employeeDebts[row.employee] += totalSum;
                                }
                            }
                        }
                    }
                }
            }
        });
    });
    
    displayTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid, employeeDebts);
}

function calculateMainTotals() {
    let totalAll = 0;
    let totalPaid = 0;
    let totalUnpaid = 0;
    let totalSom = 0;
    let totalSomPaid = 0;
    let totalSomUnpaid = 0;
    
    orders.forEach(order => {
        const headers = order.data[0];
        order.data.forEach((row, idx) => {
            if (idx > 0 && row.data && row.data.some(cell => cell && String(cell).trim() !== '')) {
                if (isHeaderRow(row, headers)) return;
                
                if (mainFilter === 'all' || 
                    (mainFilter === 'paid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') || 
                    (mainFilter === 'unpaid' && row.status === '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ')) {
                    
                    const sumDollar = parseFloat(row.data[11]) || 0;
                    const yulKira = parseFloat(row.data[12]) || 0;
                    const totalSum = sumDollar + yulKira;
                    const som = calculateSom(sumDollar, yulKira);
                    
                    totalAll += totalSum;
                    totalSom += som;
                    
                    if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                        totalPaid += totalSum;
                        totalSomPaid += som;
                    } else {
                        totalUnpaid += totalSum;
                        totalSomUnpaid += som;
                    }
                }
            }
        });
    });
    
    displayMainTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid);
}

function calculateModalTotals() {
    if (!currentOrder) return { totalAll: 0, totalPaid: 0, totalUnpaid: 0, totalSom: 0, totalSomPaid: 0, totalSomUnpaid: 0 };
    
    let totalAll = 0;
    let totalPaid = 0;
    let totalUnpaid = 0;
    let totalSom = 0;
    let totalSomPaid = 0;
    let totalSomUnpaid = 0;
    
    const headers = currentOrder.data[0];
    currentOrder.data.forEach((row, idx) => {
        if (idx > 0 && row.data && row.data.some(cell => cell && String(cell).trim() !== '')) {
            if (isHeaderRow(row, headers)) return;
            
            if (modalFilter === 'all' || 
                (modalFilter === 'paid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') || 
                (modalFilter === 'unpaid' && row.status === '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ')) {
                
                const sumDollar = parseFloat(row.data[11]) || 0;
                const yulKira = parseFloat(row.data[12]) || 0;
                const totalSum = sumDollar + yulKira;
                const som = calculateSom(sumDollar, yulKira);
                
                totalAll += totalSum;
                totalSom += som;
                
                if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                    totalPaid += totalSum;
                    totalSomPaid += som;
                } else {
                    totalUnpaid += totalSum;
                    totalSomUnpaid += som;
                }
            }
        }
    });
    
    return { totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid };
}

function displayMainTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid) {
    const container = document.getElementById('mainTotalsSummary');
    
    if (orders.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    let html = `
        <h3 style="margin-bottom: 15px; color: #2c3e50; text-align: center;">üìä –û–±—â–∏–µ —Å—É–º–º—ã</h3>
        <div class="totals-grid">
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ ($)</div>
                <div class="total-card-value total-all">${totalAll.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-paid">${totalPaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-unpaid">${totalUnpaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ (—Å–æ–º)</div>
                <div class="total-card-value total-som">${totalSom.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-paid">${totalSomPaid.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-unpaid">${totalSomUnpaid.toLocaleString()} —Å</div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function displayModalTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid) {
    const container = document.getElementById('modalTotalsSummary');
    
    let html = `
        <h3 style="margin-bottom: 15px; color: #2c3e50; text-align: center;">üìä –ò—Ç–æ–≥–∏ –ø–æ —Ä–µ–π—Å—É</h3>
        <div class="totals-grid">
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ ($)</div>
                <div class="total-card-value total-all">${totalAll.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-paid">${totalPaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-unpaid">${totalUnpaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ (—Å–æ–º)</div>
                <div class="total-card-value total-som">${totalSom.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-paid">${totalSomPaid.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-unpaid">${totalSomUnpaid.toLocaleString()} —Å</div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function displayTotals(totalAll, totalPaid, totalUnpaid, totalSom, totalSomPaid, totalSomUnpaid, employeeDebts) {
    const container = document.getElementById('totalsSummary');
    
    let html = `
        <h3 style="margin-bottom: 15px; color: #2c3e50; text-align: center;">üìä –ò—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã</h3>
        <div class="totals-grid">
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ ($)</div>
                <div class="total-card-value total-all">${totalAll.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-paid">${totalPaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ ($)</div>
                <div class="total-card-value total-unpaid">${totalUnpaid.toFixed(2)} $</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">–û–±—â–∞—è —Å—É–º–º–∞ (—Å–æ–º)</div>
                <div class="total-card-value total-som">${totalSom.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-paid">${totalSomPaid.toLocaleString()} —Å</div>
            </div>
            <div class="total-card">
                <div class="total-card-label">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ (—Å–æ–º)</div>
                <div class="total-card-value total-unpaid">${totalSomUnpaid.toLocaleString()} —Å</div>
            </div>
        </div>
    `;
    
    if (Object.keys(employeeDebts).length > 0) {
        html += '<div class="employee-debts"><h4 style="margin-bottom: 10px; color: #2c3e50;">üí∞ –î–æ–ª–≥–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º (–≤ –¥–æ–ª–ª–∞—Ä–∞—Ö):</h4>';
        for (let employee in employeeDebts) {
            html += `
                <div class="employee-debt-item">
                    <span class="employee-name">${employee}</span>
                    <span class="employee-debt">${employeeDebts[employee].toFixed(2)} $</span>
                </div>
            `;
        }
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function renderAll() {
    renderOrderCards();
    renderDatabase();
    calculateTotals();
    calculateMainTotals();
}

function renderOrderCards() {
    const grid = document.getElementById('ordersGrid');
    grid.innerHTML = '';

    orders.forEach(order => {
        const dataRows = order.data.filter((r, i) => i > 0);
        const paidCount = dataRows.filter(r => r.status === '–æ–ø–ª–∞—á–µ–Ω–æ').length;
        const unpaidCount = dataRows.length - paidCount;
        
        if (mainFilter === 'paid' && paidCount === 0) return;
        if (mainFilter === 'unpaid' && unpaidCount === 0) return;
        
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
            <div class="order-card-content" onclick="showOrderDetails(orders.find(o => o.id === ${order.id}))">
                <div class="order-icon">üì¶</div>
                <div class="order-title">${order.fileName}</div>
                <div class="order-info">üìÖ ${order.uploadDate}</div>
                <div class="order-info">üìä ${dataRows.length} –∑–∞–ø–∏—Å–µ–π</div>
                <div class="order-info" style="color: #27ae60; font-weight: 600;">‚úÖ ${paidCount}</div>
                <div class="order-info" style="color: #e74c3c; font-weight: 600;">‚ùå ${unpaidCount}</div>
            </div>
            <div class="order-actions">
                <button class="btn btn-delete" onclick="deleteOrder(${order.id}, event)">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

function setMainFilter(filter) {
    mainFilter = filter;
    const btns = document.querySelectorAll('.filters .filter-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderOrderCards();
    calculateMainTotals();
}

function setFilter(filter) {
    currentFilter = filter;
    const btns = document.querySelectorAll('#databaseTab .filter-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderAll();
}

function setModalFilter(filter) {
    modalFilter = filter;
    const btns = document.querySelectorAll('#modal .filter-btn');
    btns.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    showOrderDetails(currentOrder);
}

function filterByEmployee() {
    employeeFilter = document.getElementById('employeeFilter').value;
    renderAll();
}

function filterByDate() {
    dateFilterFrom = document.getElementById('dateFilterFrom').value;
    dateFilterTo = document.getElementById('dateFilterTo').value;
    renderAll();
}

function clearDateFilter() {
    document.getElementById('dateFilterFrom').value = '';
    document.getElementById('dateFilterTo').value = '';
    dateFilterFrom = '';
    dateFilterTo = '';
    renderAll();
}

function printInvoice(orderId, rowId) {
    const order = orders.find(o => o.id == orderId);
    if (!order) return;
    
    const row = order.data.find(r => r.rowId === rowId);
    if (!row) return;
    
    const sumDollar = parseFloat(row.data[11]) || 0;
    const yulKira = parseFloat(row.data[12]) || 0;
    const totalSom = calculateSom(sumDollar, yulKira);
    
    const invoiceHTML = `
        <div class="print-invoice">
            <div class="print-invoice-header">
                –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ö–ª–∏–µ–Ω—Ç–∞: ${row.data[1] || ''}
            </div>
            <table class="print-invoice-table">
                <thead>
                    <tr>
                        <th>–†–µ–π—Å</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–£–ø–∞–∫</th>
                        <th>–ö–ì</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–°—É–º–º–∞$</th>
                        <th>–ô—É–ª –∫–∏—Ä–∞$</th>
                        <th>–°–æ–º</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                       <td>${order.fileName || ''}</td>
                        <td>${row.data[4] || ''}</td>
                        <td>${row.data[5] || ''}</td>
                        <td>${row.data[6] || ''}</td>
                        <td>${row.data[7] || ''}</td>
                        <td>${row.data[9] || ''}</td>
                        <td>${row.data[10] || ''}</td>
                        <td>${sumDollar.toFixed(2)}</td>
                        <td>${yulKira.toFixed(2)}</td>
                        <td>${totalSom.toLocaleString()}</td>
                    </tr>
                    <tr><td colspan="10" style="height: 35px;"></td></tr>
                    <tr><td colspan="10" style="height: 35px;"></td></tr>
                    <tr><td colspan="10" style="height: 35px;"></td></tr>
                </tbody>
            </table>
            <div class="print-invoice-footer">
                <div>–ü–æ–¥–ø–∏—Å—å –ü–æ–ª—É—á–∞—Ç–µ–ª—è –¥–µ–Ω–µ–≥: _________________</div>
                <div>–ü–æ–¥–ø–∏—Å—å –ü–æ–ª—É—á–∞—Ç–µ–ª—è –¢–æ–≤–∞—Ä–∞: _________________</div>
            </div>
        </div>
    `;
    
    const printArea = document.getElementById('invoicePrintArea');
    printArea.innerHTML = invoiceHTML + invoiceHTML;
    
    window.print();
    
    setTimeout(() => {
        printArea.innerHTML = '';
    }, 1000);
}

function downloadAllOrders() {
    if (orders.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const exportData = [];
    const headers = ['–†–µ–π—Å', '‚Ññ', '–§–ò–û', '–ì–æ—Ä–æ–¥', '–≥/–ø', '–¢–µ–ª–µ—Ñ–æ–Ω', '–ù–∞–∏–º–æ–≤–∞–Ω–∏–µ', '–ú–µ—Å—Ç–æ', '–£–ø–∞–∫', '—à—Ç', '–∫–≥', '–¶–µ–Ω–∞$', '–°—É–º–º–∞$', '–ô—É–ª –∫–∏—Ä–∞$', '–°–æ–º', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã'];
    exportData.push(headers);
    
    let totalSumDollar = 0;
    let totalYulKira = 0;
    let totalSom = 0;

    orders.forEach(order => {
        const dataRows = order.data.filter((r, i) => i > 0);
        const orderHeaders = order.data[0];
        
        dataRows.forEach(row => {
            if (isHeaderRow(row, orderHeaders)) return;
            
            const hasData = row.data.some(cell => cell && String(cell).trim() !== '');
            if (!hasData) return;

            if (mainFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (mainFilter === 'unpaid' && row.status !== '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') return;

            const sumDollar = parseFloat(row.data[11]) || 0;
            const yulKira = parseFloat(row.data[12]) || 0;
            const som = calculateSom(sumDollar, yulKira);
            
            totalSumDollar += sumDollar;
            totalYulKira += yulKira;
            totalSom += som;

            const exportRow = [
                order.fileName,
                ...row.data.slice(0, 13),
                som,
                row.employee || '',
                row.status,
                row.paymentDate || '-'
            ];
            exportData.push(exportRow);
        });
    });

    const totalRow = new Array(headers.length).fill('');
    totalRow[0] = '–ò–¢–û–ì–û:';
    totalRow[12] = totalSumDollar.toFixed(2);
    totalRow[13] = totalYulKira.toFixed(2);
    totalRow[14] = totalSom;
    exportData.push(totalRow);
    
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–í—Å–µ —Ä–µ–π—Å—ã');
    
    const date = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
    const fileName = `–í—Å–µ_—Ä–µ–π—Å—ã_${date}.xlsx`;
    XLSX.writeFile(wb, fileName);
}

function downloadDatabase() {
    if (orders.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }

    const exportData = [];
    const headers = ['–†–µ–π—Å', '‚Ññ', '–§–ò–û', '–ì–æ—Ä–æ–¥', '–≥/–ø', '–¢–µ–ª–µ—Ñ–æ–Ω', '–ù–∞–∏–º–æ–≤–∞–Ω–∏–µ', '–ú–µ—Å—Ç–æ', '–£–ø–∞–∫', '—à—Ç', '–∫–≥', '–¶–µ–Ω–∞$', '–°—É–º–º–∞$', '–ô—É–ª –∫–∏—Ä–∞$', '–°–æ–º', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã'];
    exportData.push(headers);
    
    let totalSumDollar = 0;
    let totalYulKira = 0;
    let totalSom = 0;

    orders.forEach(order => {
        const dataRows = order.data.filter((r, i) => i > 0);
        const orderHeaders = order.data[0];
        
        dataRows.forEach(row => {
            if (isHeaderRow(row, orderHeaders)) return;
            
            const hasData = row.data.some(cell => cell && String(cell).trim() !== '');
            if (!hasData) return;

            if (currentFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (currentFilter === 'unpaid' && row.status !== '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (employeeFilter && row.employee !== employeeFilter) return;
            if (!isDateInRange(row.paymentDate)) return;

            const sumDollar = parseFloat(row.data[11]) || 0;
            const yulKira = parseFloat(row.data[12]) || 0;
            const som = calculateSom(sumDollar, yulKira);
            
            totalSumDollar += sumDollar;
            totalYulKira += yulKira;
            totalSom += som;

            const exportRow = [
                order.fileName,
                ...row.data.slice(0, 13),
                som,
                row.employee || '',
                row.status,
                row.paymentDate || '-'
            ];
            exportData.push(exportRow);
        });
    });

    const totalRow = new Array(headers.length).fill('');
    totalRow[0] = '–ò–¢–û–ì–û:';
    totalRow[12] = totalSumDollar.toFixed(2);
    totalRow[13] = totalYulKira.toFixed(2);
    totalRow[14] = totalSom;
    exportData.push(totalRow);
    
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö');
    
    const date = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
    const fileName = `–ë–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö_${date}.xlsx`;
    XLSX.writeFile(wb, fileName);
}

function renderDatabase() {
    const thead = document.getElementById('databaseTableHead');
    const tbody = document.getElementById('databaseTableBody');
    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100" style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
    }

    const headerRow = document.createElement('tr');
    headerRow.innerHTML = '<th>–†–µ–π—Å</th><th>‚Ññ</th><th>–§–ò–û</th><th>–ì–æ—Ä–æ–¥</th><th>–≥/–ø</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ù–∞–∏–º–æ–≤–∞–Ω–∏–µ</th><th>–ú–µ—Å—Ç–æ</th><th>–£–ø–∞–∫</th><th>—à—Ç</th><th>–∫–≥</th><th>–¶–µ–Ω–∞$</th><th>–°—É–º–º–∞$</th><th>–ô—É–ª –∫–∏—Ä–∞$</th><th>–°–æ–º</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th><th>–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>';
    thead.appendChild(headerRow);

    let totalSumDollar = 0;
    let totalYulKira = 0;
    let totalSom = 0;

    orders.forEach(order => {
        const dataRows = order.data.filter((r, i) => i > 0);
        const headers = order.data[0];
        
        dataRows.forEach(row => {
            if (isHeaderRow(row, headers)) return;
            
            const hasData = row.data.some(cell => cell && String(cell).trim() !== '');
            if (!hasData) return;

            if (currentFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (currentFilter === 'unpaid' && row.status !== '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (employeeFilter && row.employee !== employeeFilter) return;
            if (!isDateInRange(row.paymentDate)) return;

            const sumDollar = parseFloat(row.data[11]) || 0;
            const yulKira = parseFloat(row.data[12]) || 0;
            const som = calculateSom(sumDollar, yulKira);
            
            totalSumDollar += sumDollar;
            totalYulKira += yulKira;
            totalSom += som;

            const tr = document.createElement('tr');
            
            tr.innerHTML = `<td style="font-weight: bold;">${order.fileName}</td>`;
            
            for (let i = 0; i < 13; i++) {
                const value = row.data[i] || '';
                const isEditable = i !== findPriceColumn(headers);
                if (isEditable) {
                    tr.innerHTML += `<td class="editable-cell" onclick="editCellDB('${order.id}', ${row.rowId}, ${i}, this)">${value}</td>`;
                } else {
                    tr.innerHTML += `<td>${value}</td>`;
                }
            }
            
            tr.innerHTML += `<td class="som-column">${som.toLocaleString()}</td>`;
            
            const employeeName = row.employee || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω';
            tr.innerHTML += `<td style="text-align: center; cursor: pointer; background: #e3f2fd;">
                <select onchange="updateEmployee('${order.id}', ${row.rowId}, this.value)" style="width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #667eea;" class="employee-select">
                    <option value="">–í—ã–±—Ä–∞—Ç—å</option>
                    ${EMPLOYEES.map(emp => `<option value="${emp}" ${employeeName === emp ? 'selected' : ''}>${emp}</option>`).join('')}
                </select>
            </td>`;
            
            const statusClass = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? 'status-paid' : 'status-unpaid';
            const statusText = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ' : '‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
            const paymentDateText = row.paymentDate || '-';
            
            tr.innerHTML += `
                <td class="status-cell ${statusClass}" onclick="toggleRowStatusFromDB('${order.id}', ${row.rowId})">${statusText}</td>
                <td style="text-align: center;">${paymentDateText}</td>
                <td style="text-align: center;">
                    <button class="btn btn-print-invoice" onclick="printInvoice('${order.id}', ${row.rowId})">üñ®Ô∏è</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    });

    if (tbody.children.length > 0) {
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        totalRow.innerHTML = `
            <td colspan="12" style="text-align: right; padding-right: 15px;">–ò–¢–û–ì–û:</td>
            <td style="text-align: center;"><strong>${totalSumDollar.toFixed(2)}</strong></td>
            <td style="text-align: center;"><strong>${totalYulKira.toFixed(2)}</strong></td>
            <td class="som-column" style="text-align: center;"><strong>${totalSom.toLocaleString()}</strong></td>
            <td colspan="4"></td>
        `;
        tbody.appendChild(totalRow);
    }
}

window.updateEmployee = function(orderId, rowId, value) {
    const order = orders.find(o => o.id == orderId);
    if (order) {
        const row = order.data.find(r => r.rowId === rowId);
        if (row) {
            row.employee = value;
            saveUserOrders();
        }
    }
}

window.editCellDB = function(orderId, rowId, colIndex, cellElement) {
    const currentValue = cellElement.textContent;
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input';
    input.value = currentValue;
    
    cellElement.textContent = '';
    cellElement.appendChild(input);
    input.focus();
    input.select();
    
    function saveEdit() {
        const newValue = input.value;
        const order = orders.find(o => o.id == orderId);
        if (order) {
            const row = order.data.find(r => r.rowId === rowId);
            if (row) {
                row.data[colIndex] = newValue;
                
                if (colIndex === 9 || colIndex === 10) {
                    const kg = parseFloat(row.data[9]) || 0;
                    const price = parseFloat(row.data[10]) || 0;
                    row.data[11] = (kg * price).toFixed(2);
                }
                
                saveUserOrders();
                renderDatabase();
            }
        }
    }
    
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            saveEdit();
        }
    });
}

function showOrderDetails(order) {
    currentOrder = order;
    document.getElementById('modalTitle').textContent = order.fileName;
    
    if (order.data.length === 0) {
        document.getElementById('tableWrapper').innerHTML = '<p style="text-align: center; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        modal.classList.add('active');
        return;
    }

    const totals = calculateModalTotals();
    displayModalTotals(totals.totalAll, totals.totalPaid, totals.totalUnpaid, totals.totalSom, totals.totalSomPaid, totals.totalSomUnpaid);

    let tableHTML = '<table class="database-table">';
    
    const headers = order.data[0];
    const priceIdx = findPriceColumn(headers);
    
    let totalSumDollar = 0;
    let totalYulKira = 0;
    let totalSom = 0;

    order.data.forEach((row, rowIndex) => {
        if (rowIndex === 0) {
            tableHTML += '<thead><tr>';
            tableHTML += '<th>‚Ññ</th><th>–§–ò–û</th><th>–ì–æ—Ä–æ–¥</th><th>–≥/–ø</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ù–∞–∏–º–æ–≤–∞–Ω–∏–µ</th><th>–ú–µ—Å—Ç–æ</th><th>–£–ø–∞–∫</th><th>—à—Ç</th><th>–∫–≥</th><th>–¶–µ–Ω–∞$</th><th>–°—É–º–º–∞$</th><th>–ô—É–ª –∫–∏—Ä–∞$</th><th>–°–æ–º</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th><th>–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>';
        } else {
            if (isHeaderRow(row, headers)) return;
            
            if (modalFilter === 'paid' && row.status !== '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            if (modalFilter === 'unpaid' && row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') return;
            
            const rowData = row.data;
            const hasData = rowData.some(cell => cell && String(cell).trim() !== '');
            if (!hasData) return;
            
            const sumDollar = parseFloat(rowData[11]) || 0;
            const yulKira = parseFloat(rowData[12]) || 0;
            const som = calculateSom(sumDollar, yulKira);
            
            totalSumDollar += sumDollar;
            totalYulKira += yulKira;
            totalSom += som;
            
            tableHTML += '<tr>';
            
            for (let colIndex = 0; colIndex < 13; colIndex++) {
                const value = rowData[colIndex] || '';
                if (colIndex !== priceIdx) {
                    tableHTML += `<td class="editable-cell" onclick="editCell('${order.id}', ${row.rowId}, ${colIndex}, this)">${value}</td>`;
                } else {
                    tableHTML += `<td>${value}</td>`;
                }
            }
            
            tableHTML += `<td class="som-column">${som.toLocaleString()}</td>`;
            
            const employeeName = row.employee || '';
            tableHTML += `<td style="text-align: center; background: #e3f2fd;">
                <select onchange="updateEmployeeModal('${order.id}', ${row.rowId}, this.value)" style="width: 100%; padding: 5px; border-radius: 5px; border: 1px solid #667eea;">
                    <option value="">–í—ã–±—Ä–∞—Ç—å</option>
                    ${EMPLOYEES.map(emp => `<option value="${emp}" ${employeeName === emp ? 'selected' : ''}>${emp}</option>`).join('')}
                </select>
            </td>`;
            
            const statusClass = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? 'status-paid' : 'status-unpaid';
            const statusText = row.status === '–æ–ø–ª–∞—á–µ–Ω–æ' ? '‚úÖ –û–ø–ª–∞—á–µ–Ω–æ' : '‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
            const paymentDateText = row.paymentDate || '-';
            
            tableHTML += `
                <td class="status-cell ${statusClass}" onclick="toggleRowStatus('${order.id}', ${row.rowId})">${statusText}</td>
                <td style="text-align: center;">${paymentDateText}</td>
                <td style="text-align: center;">
                    <button class="btn btn-print-invoice" onclick="printInvoice('${order.id}', ${row.rowId})">üñ®Ô∏è</button>
                </td>
            `;
            tableHTML += '</tr>';
        }
    });
    
    tableHTML += `
        <tr class="total-row">
            <td colspan="11" style="text-align: right; padding-right: 15px;">–ò–¢–û–ì–û:</td>
            <td style="text-align: center;"><strong>${totalSumDollar.toFixed(2)}</strong></td>
            <td style="text-align: center;"><strong>${totalYulKira.toFixed(2)}</strong></td>
            <td class="som-column" style="text-align: center;"><strong>${totalSom.toLocaleString()}</strong></td>
            <td colspan="4"></td>
        </tr>
    `;

    tableHTML += '</tbody></table>';
    document.getElementById('tableWrapper').innerHTML = tableHTML;
    modal.classList.add('active');
}

window.editCell = function(orderId, rowId, colIndex, cellElement) {
    const currentValue = cellElement.textContent;
    
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'cell-input';
    input.value = currentValue;
    
    cellElement.textContent = '';
    cellElement.appendChild(input);
    input.focus();
    input.select();
    
    function saveEdit() {
        const newValue = input.value;
        const order = orders.find(o => o.id == orderId);
        if (order) {
            const row = order.data.find(r => r.rowId === rowId);
            if (row) {
                row.data[colIndex] = newValue;
                
                if (colIndex === 9 || colIndex === 10) {
                    const kg = parseFloat(row.data[9]) || 0;
                    const price = parseFloat(row.data[10]) || 0;
                    row.data[11] = (kg * price).toFixed(2);
                }
                
                saveUserOrders();
                showOrderDetails(order);
                renderDatabase();
            }
        }
    }
    
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            saveEdit();
        }
    });
}

window.updateEmployeeModal = function(orderId, rowId, value) {
    const order = orders.find(o => o.id == orderId);
    if (order) {
        const row = order.data.find(r => r.rowId === rowId);
        if (row) {
            row.employee = value;
            saveUserOrders();
            showOrderDetails(order);
        }
    }
}

window.toggleRowStatus = function(orderId, rowId) {
    const order = orders.find(o => o.id == orderId);
    if (order) {
        const row = order.data.find(r => r.rowId === rowId);
        if (row) {
            if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                row.status = '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                row.paymentDate = null;
            } else {
                row.status = '–æ–ø–ª–∞—á–µ–Ω–æ';
                const now = new Date();
                row.paymentDate = now.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            saveUserOrders();
            showOrderDetails(order);
            renderAll();
        }
    }
}

window.toggleRowStatusFromDB = function(orderId, rowId) {
    const order = orders.find(o => o.id == orderId);
    if (order) {
        const row = order.data.find(r => r.rowId === rowId);
        if (row) {
            if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                row.status = '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                row.paymentDate = null;
            } else {
                row.status = '–æ–ø–ª–∞—á–µ–Ω–æ';
                const now = new Date();
                row.paymentDate = now.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            saveUserOrders();
            renderAll();
        }
    }
}

window.downloadCurrentOrder = function(type) {
    if (!currentOrder) return;
    
    const exportData = [];
    const headers = currentOrder.data[0];
    exportData.push(headers);
    
    let totalSumDollar = 0;
    let totalYulKira = 0;
    
    currentOrder.data.forEach((row, index) => {
        if (index > 0) {
            const hasData = row.data.some(cell => cell && String(cell).trim() !== '');
            if (hasData) {
                if (type === 'unpaid' && row.status === '–Ω–µ –æ–ø–ª–∞—á–µ–Ω–æ') {
                    exportData.push(row.data);
                    const sumDollar = parseFloat(row.data[11]) || 0;
                    const yulKira = parseFloat(row.data[12]) || 0;
                    totalSumDollar += sumDollar;
                    totalYulKira += yulKira;
                } else if (type === 'all') {
                    exportData.push(row.data);
                    const sumDollar = parseFloat(row.data[11]) || 0;
                    const yulKira = parseFloat(row.data[12]) || 0;
                    totalSumDollar += sumDollar;
                    totalYulKira += yulKira;
                }
            }
        }
    });
    
    const totalRow = new Array(headers.length).fill('');
    totalRow[10] = '–ò–¢–û–ì–û:';
    totalRow[11] = totalSumDollar.toFixed(2);
    totalRow[12] = totalYulKira.toFixed(2);
    exportData.push(totalRow);
    
    const ws = XLSX.utils.aoa_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, type === 'unpaid' ? '–ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ' : '–í—Å–µ');
    
    const suffix = type === 'unpaid' ? '_–Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ' : '_–≤—Å–µ';
    const fileName = currentOrder.fileName.replace('.xlsx', '').replace('.xls', '') + suffix + '.xlsx';
    XLSX.writeFile(wb, fileName);
}

window.printMain = function() {
    window.print();
}

window.printDatabase = function() {
    window.print();
}

window.printModal = function() {
    window.print();
}

window.filterDatabaseTable = function() {
    const searchValue = document.getElementById('dbSearchInput').value.toLowerCase();
    const tbody = document.getElementById('databaseTableBody');
    const rows = tbody.getElementsByTagName('tr');
    
    let visibleTotalSumDollar = 0;
    let visibleTotalYulKira = 0;
    let visibleTotalSom = 0;
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        if (row.classList.contains('total-row')) continue;
        
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length; j++) {
            const cellText = cells[j].textContent.toLowerCase();
            if (cellText.includes(searchValue)) {
                found = true;
                break;
            }
        }
        
        if (found || searchValue === '') {
            row.style.display = '';
            if (cells.length >= 15) {
                const sumDollar = parseFloat(cells[12].textContent) || 0;
                const yulKira = parseFloat(cells[13].textContent) || 0;
                const som = parseInt(cells[14].textContent.replace(/\D/g, '')) || 0;
                visibleTotalSumDollar += sumDollar;
                visibleTotalYulKira += yulKira;
                visibleTotalSom += som;
            }
        } else {
            row.style.display = 'none';
        }
    }
    
    const totalRow = tbody.querySelector('.total-row');
    if (totalRow) {
        totalRow.innerHTML = `
            <td colspan="11" style="text-align: right; padding-right: 15px;">–ò–¢–û–ì–û:</td>
            <td style="text-align: center;"><strong>${visibleTotalSumDollar.toFixed(2)}</strong></td>
            <td style="text-align: center;"><strong>${visibleTotalYulKira.toFixed(2)}</strong></td>
            <td class="som-column" style="text-align: center;"><strong>${visibleTotalSom.toLocaleString()}</strong></td>
            <td colspan="4"></td>
        `;
    }
}

function renderAdminPanel() {
    document.getElementById('kgzRateInput').value = getKgzRate();
    renderUsersTable();
    renderUserStats();
}

window.updateKgzRate = function(value) {
    const rate = parseFloat(value);
    if (rate && rate > 0) {
        setKgzRate(rate);
        renderAll();
        alert('‚úÖ –ö—É—Ä—Å –æ–±–Ω–æ–≤–ª–µ–Ω: ' + rate + ' —Å–æ–º');
    } else {
        alert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–∞');
        document.getElementById('kgzRateInput').value = getKgzRate();
    }
}

function renderUsersTable() {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';

    users.forEach((user, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-weight: 600;">${user.email}</td>
            <td>
                <input type="text" value="${user.password}" 
                       onchange="updateUserPassword(${index}, this.value)"
                       style="width: 100%; padding: 5px; border: 1px solid #667eea; border-radius: 5px;">
            </td>
            <td style="text-align: center;">
                <span style="padding: 5px 15px; border-radius: 20px; font-weight: 600; 
                             background: ${user.isAdmin ? '#27ae60' : '#3498db'}; color: white;">
                    ${user.isAdmin ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                </span>
            </td>
            <td style="text-align: center;">
                ${!user.isAdmin ? `<button class="btn btn-danger" onclick="deleteUser(${index})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : '<span style="color: #95a5a6;">–ó–∞—â–∏—â–µ–Ω–æ</span>'}
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function renderUserStats() {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
    const container = document.getElementById('userStatsContainer');
    
    let statsHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">';
    
    users.forEach(user => {
        const userOrders = allOrders.filter(o => o.userEmail === user.email);
        let totalOrders = 0;
        let totalPaid = 0;
        let totalUnpaid = 0;
        
        userOrders.forEach(order => {
            order.data.forEach((row, idx) => {
                if (idx > 0 && row.data && row.data.some(cell => cell && String(cell).trim() !== '')) {
                    totalOrders++;
                    if (row.status === '–æ–ø–ª–∞—á–µ–Ω–æ') {
                        totalPaid++;
                    } else {
                        totalUnpaid++;
                    }
                }
            });
        });
        
        statsHTML += `
            <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">${user.isAdmin ? 'üëë' : 'üë§'} ${user.email}</h3>
                <div style="color: #7f8c8d; font-size: 0.95em;">
                    <div style="margin-bottom: 8px;">üì¶ –í—Å–µ–≥–æ —Ä–µ–π—Å–æ–≤: <strong>${userOrders.length}</strong></div>
                    <div style="margin-bottom: 8px;">üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <strong>${totalOrders}</strong></div>
                    <div style="margin-bottom: 8px; color: #27ae60;">‚úÖ –û–ø–ª–∞—á–µ–Ω–æ: <strong>${totalPaid}</strong></div>
                    <div style="color: #e74c3c;">‚ùå –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ: <strong>${totalUnpaid}</strong></div>
                </div>
            </div>
        `;
    });
    
    statsHTML += '</div>';
    container.innerHTML = statsHTML;
}

window.addNewUser = function() {
    const email = document.getElementById('newUserEmail').value.trim();
    const password = document.getElementById('newUserPassword').value;
    const messageDiv = document.getElementById('addUserMessage');

    if (!email || !password) {
        messageDiv.style.color = '#e74c3c';
        messageDiv.textContent = '‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        return;
    }

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    
    if (users.find(u => u.email === email)) {
        messageDiv.style.color = '#e74c3c';
        messageDiv.textContent = '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
        return;
    }

    users.push({ email, password, isAdmin: false });
    localStorage.setItem('users', JSON.stringify(users));

    messageDiv.style.color = '#27ae60';
    messageDiv.textContent = '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω';
    
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserPassword').value = '';

    setTimeout(() => {
        messageDiv.textContent = '';
    }, 3000);

    renderAdminPanel();
}

window.updateUserPassword = function(index, newPassword) {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    if (users[index]) {
        users[index].password = newPassword;
        localStorage.setItem('users', JSON.stringify(users));
    }
}

window.deleteUser = function(index) {
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    
    if (users[index] && users[index].isAdmin) {
        alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
        return;
    }

    if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${users[index].email}?`)) {
        const userEmail = users[index].email;
        users.splice(index, 1);
        localStorage.setItem('users', JSON.stringify(users));
        
        localStorage.removeItem(`orders_${userEmail}`);
        
        let allOrders = JSON.parse(localStorage.getItem('all_orders') || '[]');
        allOrders = allOrders.filter(o => o.userEmail !== userEmail);
        localStorage.setItem('all_orders', JSON.stringify(allOrders));
        
        renderAdminPanel();
    }
}

window.printInvoice = printInvoice;
window.downloadDatabase = downloadDatabase;
window.downloadAllOrders = downloadAllOrders;

init();
    </script>
</body>
</html>